# Pathfinding Tests

This directory contains benchmarking tools, scenario generators, and an interactive playground for testing and optimizing pathfinding algorithms in OpenFrontIO.

## TLDR

```bash
npx tsx tests/pathfinding/benchmark.ts --synthetic --all
npx tsx tests/pathfinding/playground/server.ts
```

## Directory Structure

```
tests/pathfinding/
├── benchmark.ts          # Benchmarking tool
├── scenarios/            # Scenarios for benchmarks
│   ├── default.ts        # Hand-picked scenario
│   └── synthetic/        # Auto-generated synthetic scenarios
└── playground/           # Interactive web-based visualization
```

## Available algorithms

- **NavSat** - **future** implementation - NavigationSatellite (HPA*)
- **PF.Mini** - **current** implementation - PathFinder.Mini (A*)

## Benchmarking

### Running a Single Scenario

```bash
# Run default scenario with default adapter (NavSat)
npx tsx tests/pathfinding/benchmark.ts

# Run specific scenario
npx tsx tests/pathfinding/benchmark.ts default

# Run with specific adapter
npx tsx tests/pathfinding/benchmark.ts default PF.Mini
```

### Running Synthetic Scenarios

Synthetic scenarios are auto-generated from maps with random port selections and routes.

```bash
# Run single synthetic scenario
npx tsx tests/pathfinding/benchmark.ts --synthetic iceland

# Run single synthetic scenario with specific adapter
npx tsx tests/pathfinding/benchmark.ts --synthetic iceland NavSat

# Run ALL synthetic scenarios (comprehensive benchmark)
npx tsx tests/pathfinding/benchmark.ts --synthetic --all

# Run all with specific adapter
npx tsx tests/pathfinding/benchmark.ts --synthetic --all NavSat
```

### Benchmark Metrics

The benchmark measures three key metrics:

1. **Initialization Time** - How long it takes to preprocess the map
2. **Path Distance** - Total distance across all routes (quality metric)
3. **Pathfinding Time** - How long it takes to compute paths (performance metric)

### Example Output

```
================================================================================
METRIC 1: INITIALIZATION TIME
================================================================================

Initialization time: 45.32ms

================================================================================
METRIC 2: PATH DISTANCE
================================================================================

Route                                    Path Length
Miami → Boston                           346 tiles
Miami → Houston                          212 tiles
...

Total distance: 52432 tiles
Routes completed: 22 / 22

================================================================================
METRIC 3: PATHFINDING TIME
================================================================================

Route                                    Time
Miami → Boston                           2.45ms
Miami → Houston                          1.82ms
...

Total time: 156.34ms
Average time: 7.11ms
Routes benchmarked: 22 / 22

================================================================================
SUMMARY
================================================================================

Adapter: NavigationSatellite
Scenario: default

Scores:
  Initialization: 45.32ms
  Pathfinding: 156.34ms
  Distance: 52432 tiles
```

## Comparing Adapters

Use `compare.ts` to compare two pathfinding adapters side-by-side:

```bash
# Compare NavSat vs PF.Mini (baseline)
npx tsx tests/pathfinding/compare.ts default PF.Mini NavSat

# Syntax: compare.ts <scenario> <baseline> <candidate>
```

This will show percentage differences in initialization time, pathfinding time, and path quality.

## Generating Scenarios

### Generate Synthetic Scenarios

Synthetic scenarios are generated by:
1. Finding all water shoreline tiles on a map
2. Randomly selecting 200 ports
3. Creating 1000 routes connecting nearby ports

```bash
# Generate scenario for a single map
npx tsx tests/pathfinding/generate-scenario.ts iceland

# Generate scenarios for all maps
npx tsx tests/pathfinding/generate-scenario.ts --all

# Force overwrite existing scenarios
npx tsx tests/pathfinding/generate-scenario.ts iceland --force
npx tsx tests/pathfinding/generate-scenario.ts --all --force
```

### Scenario Structure

Scenarios are TypeScript files that export:
- `PORTS` - Object mapping port names to coordinates
- `ROUTES` - Array of `[from, to]` port name pairs
- `PERFORMANCE_ITERATIONS` - Number of iterations for timing tests
- `setupGame()` - Function that loads the map and returns a Game instance

Example:

```typescript
export const PORTS: { [k: string]: [number, number] } = {
  "Miami": [1014, 694],
  "Boston": [1120, 498],
  // ...
};

export const ROUTES: Array<[keyof typeof PORTS, keyof typeof PORTS]> = [
  ["Miami", "Boston"],
  ["Miami", "Houston"],
  // ...
];

export const PERFORMANCE_ITERATIONS = 25;

export async function setupGame() {
  // Load map and return Game instance
}
```

## Interactive Playground

The playground provides a web-based UI for visualizing pathfinding results, comparing algorithms, and debugging.

### Starting the Playground

```bash
# Start with path caching enabled (default)
npx tsx tests/pathfinding/playground/server.ts

# Start without path caching (to measure uncached performance)
npx tsx tests/pathfinding/playground/server.ts --no-cache
```

Then open http://localhost:5555 in your browser.

## Workflow

When making changes to pathfinding algorithms:

1. **Before**: Run benchmark to establish baseline
2. **Implement**: Make your changes
3. **After**: Run benchmark again to compare
4. **Analyze**: Check if changes meet hypothesis
5. **Debug**: Use playground for interactive debugging

Example workflow:

```bash
# 1. Benchmark before changes
npx tsx tests/pathfinding/benchmark.ts --synthetic --all > before.txt

# 2. Make changes to NavigationSatellite.ts

# 3. Benchmark after changes
npx tsx tests/pathfinding/benchmark.ts --synthetic --all > after.txt

# 4. Compare results

# 5. Debug specific cases in playground
npx tsx tests/pathfinding/playground/server.ts
```
